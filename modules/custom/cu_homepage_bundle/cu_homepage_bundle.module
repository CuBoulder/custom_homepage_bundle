<?php

/**
 * Preprocess html.
 */
function cu_homepage_bundle_preprocess_html(&$vars) {
  // Only allow Same Origin to iframe us.
  $meta = array(
    '#type' => 'html_tag',
    '#tag' => 'meta',
    '#attributes' => array(
      'content' => 'SAMEORIGIN',
      'http-equiv' => 'X-Frame-Options',
    ),
  );
  drupal_add_html_head($meta, 'homepage_xframe_options');
  drupal_add_http_header('X-Frame-Options', 'SAMEORIGIN');
}

/**
 * Implements hook_secure_permissions().
 */
function cu_homepage_bundle_secure_permissions($role) {
  $permissions = array(
    'administrator' => array(
      'administer admission_event_series vocabulary terms',
      'administer admission_event_type vocabulary terms',
      'access_google_appliance_content',
      'administer admission_recruitment_location vocabulary terms',
      'administer audience vocabulary terms',
      'administer blog_post_tags vocabulary terms',
      'administer career_interests vocabulary terms',
      'administer categories vocabulary terms',
      'administer college_school vocabulary terms',
      'administer degrees_offered vocabulary terms',
      'administer policy_categories vocabulary terms',
      'administer resource_category vocabulary terms',
      'administer resource_sub_category vocabulary terms',
      'assign blogger role',
      'create admission_event content',
      'create any resources bean',
      'create blog_post content',
      'create degree_program content',
      'create policy content',
      'create resource content',
      'delete any admission_event content',
      'delete any blog_post content',
      'delete any degree_program content',
      'delete any policy content',
      'delete any resource content',
      'delete any resources bean',
      'delete own admission_event content',
      'delete own blog_post content',
      'delete own degree_program content',
      'delete own policy content',
      'delete own resource content',
      'delete terms in 12',
      'delete terms in 14',
      'delete terms in 16',
      'delete terms in 18',
      'delete terms in 20',
      'delete terms in 22',
      'delete terms in 24',
      'delete terms in 26',
      'delete terms in 28',
      'delete terms in 30',
      'delete terms in 31',
      'delete terms in 32',
      'edit any admission_event content',
      'edit any blog_post content',
      'edit any degree_program content',
      'edit any policy content',
      'edit any resource content',
      'edit any resources bean',
      'edit own admission_event content',
      'edit own blog_post content',
      'edit own degree_program content',
      'edit own policy content',
      'edit own resource content',
      'edit terms in 12',
      'edit terms in 14',
      'edit terms in 16',
      'edit terms in 18',
      'edit terms in 20',
      'edit terms in 22',
      'edit terms in 24',
      'edit terms in 26',
      'edit terms in 28',
      'edit terms in 30',
      'edit terms in 31',
      'edit terms in 32',
      'geocoder_service_all_handlers',
      'geocoder_service_handler_exif',
      'geocoder_service_handler_google',
      'geocoder_service_handler_gpx',
      'geocoder_service_handler_json',
      'geocoder_service_handler_kml',
      'geocoder_service_handler_latlon',
      'geocoder_service_handler_mapquest_nominatim',
      'geocoder_service_handler_wkt',
      'geocoder_service_handler_yahoo',
      'geocoder_service_handler_yandex',
      'merge terms',
      'view any resources bean',
      'view atoz',
      'view_cu_search_homepage_results',
    ),
    'anonymous user' => array(
      'access_google_appliance_content',
      'view any resources bean',
      'view atoz',
      'view_cu_search_homepage_results',
    ),
    'authenticated user' => array(
      'access_google_appliance_content',
      'view any resources bean',
      'view atoz',
      'view_cu_search_homepage_results',
    ),
    'content_editor' => array(
      'access_google_appliance_content',
      'administer admission_recruitment_location vocabulary terms',
      'administer blog_post_tags vocabulary terms',
      'administer career_interests vocabulary terms',
      'administer categories vocabulary terms',
      'administer college_school vocabulary terms',
      'administer degrees_offered vocabulary terms',
      'administer policy_categories vocabulary terms',
      'administer resource_category vocabulary terms',
      'administer resource_sub_category vocabulary terms',
      'create admission_event content',
      'create any resources bean',
      'create blog_post content',
      'create degree_program content',
      'create policy content',
      'create resource content',
      'delete any admission_event content',
      'delete any blog_post content',
      'delete any degree_program content',
      'delete any policy content',
      'delete any resource content',
      'delete any resources bean',
      'delete own admission_event content',
      'delete own blog_post content',
      'delete own degree_program content',
      'delete own policy content',
      'delete own resource content',
      'delete own resources bean',
      'delete terms in 12',
      'delete terms in 14',
      'delete terms in 16',
      'delete terms in 18',
      'delete terms in 20',
      'delete terms in 22',
      'delete terms in 24',
      'delete terms in 26',
      'delete terms in 28',
      'edit any admission_event content',
      'edit any blog_post content',
      'edit any degree_program content',
      'edit any policy content',
      'edit any resource content',
      'edit any resources bean',
      'edit own admission_event content',
      'edit own blog_post content',
      'edit own degree_program content',
      'edit own policy content',
      'edit own resource content',
      'edit own resources bean',
      'edit terms in 12',
      'edit terms in 14',
      'edit terms in 16',
      'edit terms in 18',
      'edit terms in 20',
      'edit terms in 22',
      'edit terms in 24',
      'edit terms in 26',
      'edit terms in 28',
      'geocoder_service_all_handlers',
      'geocoder_service_handler_exif',
      'geocoder_service_handler_google',
      'geocoder_service_handler_gpx',
      'geocoder_service_handler_json',
      'geocoder_service_handler_kml',
      'geocoder_service_handler_latlon',
      'geocoder_service_handler_mapquest_nominatim',
      'geocoder_service_handler_wkt',
      'geocoder_service_handler_yahoo',
      'geocoder_service_handler_yandex',
      'merge terms',
      'view any resources bean',
      'view atoz',
      'view_cu_search_homepage_results',
    ),
    'developer' => array(
      'administer admission_event_series vocabulary terms',
      'administer admission_event_type vocabulary terms',
      'access_google_appliance_content',
      'administer_google_appliance',
      'administer admission_recruitment_location vocabulary terms',
      'administer audience vocabulary terms',
      'administer blog_post_tags vocabulary terms',
      'administer career_interests vocabulary terms',
      'administer categories vocabulary terms',
      'administer college_school vocabulary terms',
      'administer degrees_offered vocabulary terms',
      'administer feeds',
      'administer feeds_tamper',
      'administer policy_categories vocabulary terms',
      'administer postal code',
      'administer resource_category vocabulary terms',
      'administer resource_sub_category vocabulary terms',
      'assign blogger role',
      'clear admission_event feeds',
      'clear admission_recruitment_locations feeds',
      'clear admission_recruitment_locations_high_school feeds',
      'clear admission_recruitment_locations_region feeds',
      'clear admission_recruitment_locations_state feeds',
      'clear person_admission_recruitment_location feeds',
      'create admission_event content',
      'create any resources bean',
      'create blog_post content',
      'create degree_program content',
      'create policy content',
      'create resource content',
      'delete any admission_event content',
      'delete any blog_post content',
      'delete any degree_program content',
      'delete any policy content',
      'delete any resource content',
      'delete any resources bean',
      'delete own admission_event content',
      'delete own blog_post content',
      'delete own degree_program content',
      'delete own policy content',
      'delete own resource content',
      'delete own resources bean',
      'delete terms in 12',
      'delete terms in 14',
      'delete terms in 16',
      'delete terms in 18',
      'delete terms in 20',
      'delete terms in 22',
      'delete terms in 24',
      'delete terms in 26',
      'delete terms in 28',
      'delete terms in 30',
      'delete terms in 31',
      'delete terms in 32',
      'edit any admission_event content',
      'edit any blog_post content',
      'edit any degree_program content',
      'edit any policy content',
      'edit any resource content',
      'edit any resources bean',
      'edit own admission_event content',
      'edit own blog_post content',
      'edit own degree_program content',
      'edit own policy content',
      'edit own resource content',
      'edit own resources bean',
      'edit terms in 12',
      'edit terms in 14',
      'edit terms in 16',
      'edit terms in 18',
      'edit terms in 20',
      'edit terms in 22',
      'edit terms in 24',
      'edit terms in 26',
      'edit terms in 28',
      'edit terms in 30',
      'edit terms in 31',
      'edit terms in 32',
      'geocoder_service_all_handlers',
      'geocoder_service_handler_exif',
      'geocoder_service_handler_google',
      'geocoder_service_handler_gpx',
      'geocoder_service_handler_json',
      'geocoder_service_handler_kml',
      'geocoder_service_handler_latlon',
      'geocoder_service_handler_mapquest_nominatim',
      'geocoder_service_handler_wkt',
      'geocoder_service_handler_yahoo',
      'geocoder_service_handler_yandex',
      'import admission_event feeds',
      'import admission_recruitment_locations feeds',
      'import admission_recruitment_locations_high_school feeds',
      'import admission_recruitment_locations_region feeds',
      'import admission_recruitment_locations_state feeds',
      'import person_admission_recruitment_location feeds',
      'merge terms',
      'tamper admission_event',
      'tamper admission_recruitment_locations',
      'tamper admission_recruitment_locations_high_school',
      'tamper admission_recruitment_locations_region',
      'tamper admission_recruitment_locations_state',
      'tamper person_admission_recruitment_location',
      'unlock admission_event feeds',
      'unlock admission_recruitment_locations feeds',
      'unlock admission_recruitment_locations_high_school feeds',
      'unlock admission_recruitment_locations_region feeds',
      'unlock admission_recruitment_locations_state feeds',
      'unlock person_admission_recruitment_location feeds',
      'view any resources bean',
      'view atoz',
      'view_cu_search_homepage_results',
    ),
    'edit_my_content' => array(
      'access_google_appliance_content',
      'view_cu_search_homepage_results',
    ),
    'site_owner' => array(
      'administer admission_event_series vocabulary terms',
      'administer admission_event_type vocabulary terms',
      'access_google_appliance_content',
      'administer admission_recruitment_location vocabulary terms',
      'administer audience vocabulary terms',
      'administer blog_post_tags vocabulary terms',
      'administer career_interests vocabulary terms',
      'administer categories vocabulary terms',
      'administer college_school vocabulary terms',
      'administer degrees_offered vocabulary terms',
      'administer policy_categories vocabulary terms',
      'administer resource_category vocabulary terms',
      'administer resource_sub_category vocabulary terms',
      'assign blogger role',
      'clear admission_event feeds',
      'create admission_event content',
      'create any resources bean',
      'create blog_post content',
      'create degree_program content',
      'create policy content',
      'create resource content',
      'delete any admission_event content',
      'delete any blog_post content',
      'delete any degree_program content',
      'delete any policy content',
      'delete any resource content',
      'delete any resources bean',
      'delete own admission_event content',
      'delete own blog_post content',
      'delete own degree_program content',
      'delete own policy content',
      'delete own resource content',
      'delete terms in 12',
      'delete terms in 14',
      'delete terms in 16',
      'delete terms in 18',
      'delete terms in 20',
      'delete terms in 22',
      'delete terms in 24',
      'delete terms in 26',
      'delete terms in 28',
      'delete terms in 30',
      'delete terms in 31',
      'delete terms in 32',
      'edit any admission_event content',
      'edit any blog_post content',
      'edit any degree_program content',
      'edit any policy content',
      'edit any resource content',
      'edit any resources bean',
      'edit own admission_event content',
      'edit own blog_post content',
      'edit own degree_program content',
      'edit own policy content',
      'edit own resource content',
      'edit terms in 12',
      'edit terms in 14',
      'edit terms in 16',
      'edit terms in 18',
      'edit terms in 20',
      'edit terms in 22',
      'edit terms in 24',
      'edit terms in 26',
      'edit terms in 28',
      'edit terms in 30',
      'edit terms in 31',
      'edit terms in 32',
      'geocoder_service_all_handlers',
      'geocoder_service_handler_exif',
      'geocoder_service_handler_google',
      'geocoder_service_handler_gpx',
      'geocoder_service_handler_json',
      'geocoder_service_handler_kml',
      'geocoder_service_handler_latlon',
      'geocoder_service_handler_mapquest_nominatim',
      'geocoder_service_handler_wkt',
      'geocoder_service_handler_yahoo',
      'geocoder_service_handler_yandex',
      'import admission_event feeds',
      'merge terms',
      'unlock admission_recruitment_locations feeds',
      'view any resources bean',
      'view atoz',
      'view_cu_search_homepage_results',
    ),
  );
  if (isset($permissions[$role])) {
    return $permissions[$role];
  }
}

/**
 * Implements hook_node_insert().
 *
 * If content is created with a path that conflicts with F5 paths,
 * redirect the user to the node edit page and warn them of the conflict.
 */
function cu_homepage_bundle_node_insert($node) {
  // Check cache for legacy paths.
  $legacy_paths = &drupal_static(__FUNCTION__);
  if (!isset($legacy_paths)) {
    if ($cache = cache_get('cu_homepage_bundle_legacy_paths')) {
      $legacy_paths = $cache->data;
    }
    else {
      // Get array of legacy site paths and set cache.
      $legacy_sites = atlas_api_request('sites', 'where={"pool":"WWWLegacy"}&projection={"path":1}&max_results=10000');

      $legacy_paths = array_map(function ($site) {
        return $site['path'];
      }, $legacy_sites['_items']);

      cache_set('cu_homepage_bundle_legacy_paths', $legacy_paths);
    }
  }

  // Get current node path.
  $path = drupal_get_path_alias('node/' . $node->nid);

  // Determine if there's a conflict between the current path and legacy paths.
  if (in_array($path, $legacy_paths)) {
    drupal_set_message(
      t('The URL alias <strong>%path</strong> conflicts with a legacy site path and will not function correctly. Please update the path or contact support for assistance.',
        array('%path' => $path)),
      'error'
    );
    drupal_goto('node/' . $node->nid . '/edit');
  }
}

/**
 * Implements hook_module_implements_alter().
 *
 * Ensures cu_homepage_bundle_node_insert() runs after pathauto_create_alias().
 */
function cu_homepage_bundle_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'node_insert') {
    // Move cu_homepage_bundle_node_insert() to the end of the list.
    $group = $implementations['cu_homepage_bundle'];
    unset($implementations['cu_homepage_bundle']);
    $implementations['cu_homepage_bundle'] = $group;
  }
}
